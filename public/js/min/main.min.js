window.socket=io.connect(window.location.origin),function(){window.Inky={Models:{},Collections:{},Views:{},Util:{}},Backbone.View.prototype.close=function(){this.remove(),this.unbind()},Inky.Util.getJSON=function(t,e){$.ajax({url:t,dataType:"json"}).done(function(t){e(null,t)}).fail(function(t,i,n){e(n)})},Inky.Util.timeago=function(t,e){var i=Math.floor((new Date-t)/1e3),n=Math.floor(i/31536e3);return"undefined"==typeof e&&(e=!1),n>1?n+(e?"yr":" years ago"):(n=Math.floor(i/2592e3),n>1?n+(e?"mth":" months ago"):(n=Math.floor(i/86400),n>1?n+(e?"d":" days ago"):(n=Math.floor(i/3600),n>=1?n+(e?"h":" hours ago"):(n=Math.floor(i/60),n>=1?n+(e?"m":" minutes ago"):Math.floor(i)+(e?"s":" seconds ago")))))},Inky.Models.Group=Backbone.Model.extend({urlRoot:"group",noIoBind:!1,socket:window.socket,idAttribute:"_id",initialize:function(){console.log("new group",this.get("title"))},isSelected:function(){return this.collection.getSelected()===this}}),Inky.Collections.Group=Backbone.Collection.extend({model:Inky.Models.Group,url:"groups",socket:window.socket,initialize:function(){this.selected=null},setSelected:function(t){this.selected&&this.selected.trigger("unselected"),t&&t.trigger("selected"),this.selected=t,this.trigger("selected:change",t)},getSelected:function(){return this.selected},getSlug:function(){return this.getSelected()?this.getSelected().id:"all"}}),Inky.Models.Post=Backbone.Model.extend({urlRoot:"post",noIoBind:!1,socket:window.socket,idAttribute:"_id",initialize:function(){console.log("new post",this.get("title")),_.bindAll(this,"serverChange","serverDelete","modelCleanup"),this.noIoBind||(this.ioBind("update",this.serverChange,this),this.ioBind("delete",this.serverDelete,this))},serverChange:function(t){t.fromServer=!0,this.set(t)},serverDelete:function(){this.collection?this.collection.remove(this):this.trigger("remove",this),this.modelCleanup()},modelCleanup:function(){return this.ioUnbindAll(),this},toTemplateData:function(){var t={};return t._id=null,t.content=this.get("content"),t.title=t.content,t.created=(new Date).getTime(),t.link="#",t.embed={},t.thumbnail="",t.comments=[],t.excerpt=t.content,t.domain=t.content.match(/^https?\:\/\/([^\/?#]+)(?:[\/?#]|$)/i)[1],t=$.extend({},t,this.toJSON()),t.group={id:t.group,title:app.groups.get(t.group).get("title"),link:"#g/"+t.group},t.persisted=null!==t._id,t.link="#g/"+(null!==app.groups.getSelected()?app.groups.getSelected().id:"all")+"/"+t._id,t.excerpt=$("<div>"+t.excerpt+"</div>").html(),t.comments||(t.comments=[]),t}}),Inky.Collections.Post=Backbone.Collection.extend({model:Inky.Models.Post,url:"posts",socket:window.socket,initialize:function(){_.bindAll(this,"serverCreate","collectionCleanup"),this.ioBind("create",this.serverCreate,this)},serverCreate:function(t){var e=this.findWhere({ucid:t.ucid});e?(t.fromServer=!0,e.set(t)):this.add(t)},collectionCleanup:function(){return this.ioUnbindAll(),this.each(function(t){t.modelCleanup()}),this}}),Inky.Views.Sidebar=Backbone.View.extend({className:"sidebar",events:{"click .compose-button":"composeClick"},initialize:function(){this.listenTo(this.model,"all",this.renderMenu)},render:function(){var t=_.template($("#template-sidebar").html(),{});return this.$el.html(t),this.renderMenu(),this},renderMenu:function(){var t=this.$el.find("#primary-sidebar"),e="";return e+='<li class="'+(null===this.model.getSelected()?"active":"")+'"><a href="#g/all" data-groupid="all">All</a></li>',this.model.forEach(function(t){e+='<li class="'+(t.isSelected()?"active":"")+'"><a href="#g/'+t.id+'">'+t.get("title")+"</a></li>"}),t.find("li:not(.initial)").remove(),t.append(e),this},composeClick:function(){app.navigate("/g/"+this.model.getSlug()+"/new/edit",{trigger:!0})}}),Inky.Views.PostsPane=Backbone.View.extend({tagName:"aside",className:"content-aside posts-list-pane",initialize:function(){this.listenTo(this.model,"all",this.render),this.selectedPost=null,this.visiblePosts=null},render:function(){var t=_.template($("#template-posts-aside").html(),{});return this.$el.html(t),this.visiblePosts=this.model.toArray().reverse(),this.renderPosts(),this},selectPost:function(t){this.selectedPost=t,this.renderPosts()},renderPosts:function(){var t=$("<div>");this.visiblePosts.forEach(function(e){t.append(_.template($("#template-posts-list-post").html(),{post:e.toTemplateData(),selected:this.selectedPost==e.id}))},this),this.$el.find(".posts").html(t.html())},showAll:function(){this.visiblePosts=this.model.toArray().reverse(),this.renderPosts()},filterByGroup:function(t){this.visiblePosts=this.model.filter(function(e){return e.get("group")==t}).reverse(),this.renderPosts()}}),Inky.Views.EditPostPane=Backbone.View.extend({className:"content-main edit-post-pane",events:{"submit form":"submitForm","click [data-click='cancel']":"onCancel"},initialize:function(){this.listenTo(this.model.get("groups"),"all",this.render)},render:function(){var t=this.model.get("post"),e=(this.model.get("posts"),this.model.get("groups")),i=_.template($("#template-edit-post").html(),{isNew:null===t,groups:e.toJSON(),content:null!==t?t.get("content"):"",comment:null!==t?t.get("comment"):""});return this.$el.html(i),this},submitForm:function(t){t.preventDefault();var e=this,i=this.model.get("post")?this.model.get("post"):new(Inky.Models.Post.extend({noIoBind:!0})),n=this.model.get("groups");i.save({ucid:uuid.v4(),author:app.author,content:$(t.target).find("input[name=content]").val(),group:$(t.target).find("select[name=group]").val(),comment:$(t.target).find("textarea[name=comment]").val()},{success:function(t){app.navigate("/g/"+n.getSlug()+"/"+t.id,{trigger:!0})},error:function(){console.log("Error saving post!")}}),e.model.get("posts").add(i),app.contentView&&app.contentView.remove()},onCancel:function(){var t=this.model.get("post"),e=this.model.get("groups");app.contentView&&app.contentView.remove(),app.postsView.selectPost(null),app.navigate(null===t?"#g/"+e.getSlug():"#g/"+e.getSlug()+"/"+t.id,{trigger:!0})}}),Inky.Views.ViewPostPane=Backbone.View.extend({className:"content-main view-post-pane",events:{"submit #comment-form":"onAddComment","click [data-click='edit']":"onEdit","click [data-click='delete']":"onDelete"},initialize:function(){this.listenTo(this.model.get("post"),"all",this.render)},render:function(){var t=this.model.get("post"),e=_.template($("#template-view-post").html(),{post:t.toTemplateData()});return this.$el.html(e),this},onEdit:function(t){t.preventDefault();var e=this.model.get("post"),i=this.model.get("groups");app.navigate("/g/"+i.getSlug()+"/"+e.id+"/edit",{trigger:!0})},onDelete:function(t){t.preventDefault();var e=this.model.get("post"),i=this.model.get("groups");confirm("Are you sure?")&&e.destroy({success:function(){app.contentView&&app.contentView.remove(),app.navigate("/g/"+i.getSlug(),{trigger:!0})}})},onAddComment:function(t){t.preventDefault();var e=this.model.get("post"),i=(e.get("comments")?e.get("comments"):[],$(t.currentTarget).find("textarea[name=comment]").val());if(i){var n={author:app.author,content:i,created:(new Date).getTime()};e.save({comments:[n]},{patch:!0})}}}),Inky.Views.SettingsPane=Backbone.View.extend({className:"content-main settings-pane","click [data-click='notifyRequestPermission']":"onNotifyInstall",initialize:function(){this.listenTo(this.model.get("groups"),"all",this.render)},render:function(){var t=_.template($("#template-settings").html(),{author:app.author,notifyHavePermission:window.webkitNotifications&&0===window.webkitNotifications.checkPermission()?!0:!1,notifySupport:!!window.webkitNotifications});return this.$el.html(t),this},onNotifyInstall:function(t){if(t.preventDefault(),window.webkitNotifications){var e=window.webkitNotifications.checkPermission();0!==e&&window.webkitNotifications.requestPermission()}}}),Inky.App=Backbone.Router.extend({routes:{"":"indexAction","/":"indexAction",settings:"settingsAction","g/:group":"groupAction","g/:group/:post/edit":"editPostAction","g/:group/:post":"viewPostAction"},initialize:function(){this.$outer=$("#outer-container"),this.groups=new Inky.Collections.Group,this.groups.fetch(),this.posts=new Inky.Collections.Post,this.posts.fetch(),this.sidebar=new Inky.Views.Sidebar({model:this.groups}),this.sidebar.render(),this.$outer.prepend(this.sidebar.$el),this.postsView=new Inky.Views.PostsPane({model:this.posts}),this.postsView.render(),this.$outer.find(".content-pane").append(this.postsView.$el),"localStorage"in window&&null!==window.localStorage&&(this.author=localStorage.getItem("handle")),this.author||(this.author=prompt("Please select your handle:"),this.author?localStorage.setItem("handle",this.author):this.author="Nameless")},indexAction:function(){this.navigate("/g/all",{trigger:!0})},settingsAction:function(){this.contentView&&this.contentView.remove(),this.postsView.selectPost(null);var t=new Backbone.Model;t.set({groups:this.groups,posts:this.posts}),this.contentView=new Inky.Views.SettingsPane({model:t}),this.contentView.render(),this.$outer.find(".content-pane").append(this.contentView.$el)},groupAction:function(t){"all"==t?(this.groups.setSelected(null),this.postsView.showAll()):(this.groups.setSelected(this.groups.get(t)),this.postsView.filterByGroup(t))},editPostAction:function(t,e){if(this.contentView&&this.contentView.remove(),"new"==e){var i=new Backbone.Model;i.set({groups:this.groups,posts:this.posts,post:null}),this.postsView.selectPost(null),this.contentView=new Inky.Views.EditPostPane({model:i}),this.contentView.render(),this.$outer.find(".content-pane").append(this.contentView.$el)}else{var n=this.posts.get(e);if(!n)return this.navigate("/g/"+(null!==this.groups.getSelected()?this.groups.getSelected().id:"all"),{trigger:!0});var i=new Backbone.Model;i.set({groups:this.groups,posts:this.posts,post:n}),this.postsView.selectPost(e),this.contentView=new Inky.Views.EditPostPane({model:i}),this.contentView.render(),this.$outer.find(".content-pane").append(this.contentView.$el)}},viewPostAction:function(t,e){this.contentView&&this.contentView.remove();var i=this.posts.get(e);if(!i)return this.navigate("/g/"+(null!==this.groups.getSelected()?this.groups.getSelected().id:"all"),{trigger:!0});this.postsView.selectPost(i.id);var n=new Backbone.Model;n.set({groups:this.groups,posts:this.posts,post:i}),this.contentView=new Inky.Views.ViewPostPane({model:n}),this.contentView.render(),this.$outer.find(".content-pane").append(this.contentView.$el)}}),$(document).ready(function(){window.app=new Inky.App,Backbone.history.start()})}();