!function(){window.App={Models:{},Collections:{},Views:{},Routers:{},Util:{}},Backbone.View.prototype.close=function(){this.remove(),this.unbind()},App.Util.getJSON=function(e,t){$.ajax({url:e,dataType:"json"}).done(function(e){t(null,e)}).fail(function(e,i,n){t(n)})},App.Models.Schema=Backbone.Model.extend({setSelected:function(){this.collection.setSelected(this)},slug:function(){return this.get("title").toLowerCase().replace(/[^\w ]+/g,"").replace(/ +/g,"-")},isSelected:function(){return this.get("_jcms_selected")?this.get("_jcms_selected"):!1}}),App.Collections.Schema=Backbone.Collection.extend({model:App.Models.Schema,initialize:function(){this.selected=null},setSelected:function(e){this.selected&&this.selected.set({_jcms_selected:!1}),e.set({_jcms_selected:!0}),this.selected=e},getSelected:function(){return this.selected}}),App.Models.Instance=Backbone.Model.extend({initialize:function(){this.id||(this.id=uuid.v4(),this.set({id:this.id})),this.isNew()||this.set("_jcms_selected",!1),this.on("change",function(){this.updateInternalTitle()},this),this.updateInternalTitle()},title:function(){return this.get("_jcms_title")&&$.trim(this.get("_jcms_title")).length>0?this.get("_jcms_title"):"New Item"},updateInternalTitle:function(){var e=this.collection.schema;if(e.get("headerTemplate")){var t=Handlebars.compile(e.get("headerTemplate"));this.set({_jcms_title:t({self:this.toJSON(),index:0,title:e.get("title")})})}else this.set({_jcms_title:this.get("title")?this.get("title"):e.get("title")})},setSelected:function(){this.collection.setSelected(this)},isSelected:function(){return this.get("_jcms_selected")?this.get("_jcms_selected"):!1},validate:function(){return this.get("_jcms_valid")&&this.get("_jcms_valid")===!0?void 0:new Error("Instance does not conform to schema")}}),App.Collections.Instance=Backbone.Collection.extend({model:App.Models.Instance,initialize:function(e,t){this.selected=null,this.schema=t.schema},url:function(){return"api/"+this.schema.slug()},setSelected:function(e){this.selected&&this.selected.set({_jcms_selected:!1}),e.set({_jcms_selected:!0}),this.selected=e},getSelected:function(){return this.selected}}),App.Views.Sidebar=Backbone.View.extend({className:"sidebar",initialize:function(){this.listenTo(this.model,"change",this.renderMenu)},render:function(){var e=_.template($("#template-sidebar").html(),{});return this.$el.html(e),this.renderMenu(),this},renderMenu:function(){var e=this.$el.find("#primary-sidebar"),t="";return this.model.forEach(function(e){t+='<li class="'+(e.isSelected()?"active":"")+'"><a href="#/s/'+e.cid+'">'+e.get("title")+"</a></li>"}),e.empty().append(t),this}}),App.Views.ContentPane=Backbone.View.extend({className:"content-pane",events:{"click .add-instance-button":"addInstance","click .btn-danger":"removeInstance"},initialize:function(){this.listenTo(this.model.instances,"add",this.updateMenu),this.listenTo(this.model.instances,"change",this.updateMenu)},render:function(){var e=this,t=_.template($("#template-content-pane").html(),{schema:this.model,instances:this.model.instances});return this.$el.html(t),window.setTimeout(function(){e.fixHeights(),e.updateMenu()},1),this},updateMenu:function(){var e=this.model,t=this.$el.find(".nav"),i=t.find(".buttons");return t.find("li").not(".buttons").remove(),this.model.instances.forEach(function(t){i.before('<li class="'+(t.isSelected()?"active":"")+" "+(t.isValid()?"valid":"invalid")+'"><a href="#/s/'+e.cid+"/"+t.id+'">'+t.title()+'</a><button class="btn btn-danger"><i class="glyphicon glyphicon-remove"></i></button></li>')}),this.fixHeights(),this},fixHeights:function(){$("#outer-container > .sidebar").height($("#editor").height()+80),$("#outer-container aside.content-aside").height($("#editor").height()+20)},addInstance:function(){var e=this.model.instances.add({});return JsonCMS.navigate("/s/"+this.model.cid+"/"+e.id,{trigger:!0}),this},removeInstance:function(){return this}}),App.Routers.Main=Backbone.Router.extend({routes:{"s/:schema":"handleSchemaChange","s/:schema/:instance":"handleInstanceChange"},initialize:function(e){this.schemaCollection=e.schemaCollection},handleSchemaChange:function(e){var t=this.schemaCollection.get(e);t.setSelected(),t.instances||(t.instances=new App.Collections.Instance([],{schema:t}),t.instances.fetch());var i=new App.Views.ContentPane({model:t});i.render(),$("#outer-container .content-pane").remove(),$("#outer-container").append(i.$el)},handleInstanceChange:function(e,t){var i=this,n=this.schemaCollection.get(e),s=n&&n.instances?n.instances.get(t):!1;if(!s)return JsonCMS.navigate("/s/"+e,{trigger:!0}),void 0;var a=s.toJSON();if(s.setSelected(),this.editor)try{this.editor.destroy()}catch(c){console.log(c)}if(this.editor=new JSONEditor($("#editor")[0],{ajax:!0,theme:"bootstrap3",iconlib:"bootstrap3",template:"handlebars",disable_collapse:!0,disable_edit_json:!0,disable_properties:!0,no_additional_properties:!0,schema:n.toJSON()}),this.editor.ready){var o=Object.keys(a).filter(function(e){return 0!==e.indexOf("_")&&"id"!==e});o.length&&i.editor.setValue(a)}else this.editor.on("ready",function(){a.length&&i.editor.setValue(a)});this.editor.on("change",function(){a=i.editor.getValue(),s.set(i.editor.getValue(a));var e=i.editor.validate();e.length?s.set({_jcms_valid:!1}):(s.set({_jcms_valid:!0}),s.save())})}}),$(document).ready(function(){JSONEditor.plugins.epiceditor.basePath="/vendor/epiceditor";var e=function(e){if(!e.length)return alert("Failed to find any existing schema(s).");var t=new App.Collections.Schema(e);window.JsonCMS=new App.Routers.Main({schemaCollection:t});var i=new App.Views.Sidebar({model:t});i.render(),$("#outer-container").append(i.$el),Backbone.history.start(),JsonCMS.navigate("/s/"+t.first().cid,{trigger:!0})};async.waterfall([function(e){App.Util.getJSON("api/schema",e)},function(e,t){async.map(e,App.Util.getJSON,t)}],function(t,i){t?alert(t.getMessage()):e(i)})})}();
//# sourceMappingURL=main.min.js.map